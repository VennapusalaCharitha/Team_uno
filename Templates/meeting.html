<html>
<head>
    <title>Meetings</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div style="display: flex; justify-content: center; align-items: top; height: 100vh;"> 
    <div id="root"  style = "width: 95%; height: 80%"></div>
    </div>
    <div id="captions" style="position:fixed; z-index: 100; display: flex; bottom:5%; justify-content: center; transform: translateY(-50%); width: 100%; background-color: #00000010; color: #fff; padding: 10px;">
        <p id="transcript"></p>
    </div>
</body>
<script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>
<script>
    window.onload = function () {
        function getUrlParams(url) {
            let urlStr = url.split('?')[1];
            const urlSearchParams = new URLSearchParams(urlStr);
            return Object.fromEntries(urlSearchParams.entries());
        }

        const roomID = getUrlParams(window.location.href)['roomID'] || (Math.floor(Math.random() * 10000) + "");
        const userID = Math.floor(Math.random() * 10000) + "";
        const userName = "{{username}}";
        const appID = 922435240;
        const serverSecret = "10ba5f5065a32112f58e459aed99e5c0";
        const kitToken = ZegoUIKitPrebuilt.generateKitTokenForTest(appID, serverSecret, roomID, userID, userName);
        const zp = ZegoUIKitPrebuilt.create(kitToken);

        // Initialize meeting room
        zp.joinRoom({
            container: document.querySelector("#root"),
            sharedLinks: [{
                name: 'Personal link',
                url: window.location.protocol + '//' + window.location.host + window.location.pathname + '?roomID=' + roomID,
            }],
            scenario: { mode: ZegoUIKitPrebuilt.VideoConference },
            turnOnMicrophoneWhenJoining: true,
            turnOnCameraWhenJoining: true,
            showMyCameraToggleButton: true,
            showMyMicrophoneToggleButton: true,
            showScreenSharingButton: true,
        });

        // Capture frames from the video element and send to backend
        setInterval(() => {
            const videoElements = document.querySelectorAll('video');
            if (videoElements.length === 0) return;

            // Capture the first video element (modify to handle multiple participants)
            const video = videoElements[0];
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convert canvas to base64
            const imageData = canvas.toDataURL('image/jpeg');

            // Send frame to backend for processing
            fetch("/process_frame", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ frame: imageData }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.transcript) {
                    document.getElementById("transcript").innerText = data.transcript;
                } 
                else {
                    document.getElementById("transcript").innerText = " ";
                }
            })
            .catch(error => console.error("Error:", error));
        }, 1000); // Send frame every 1ms
    };
</script>
</html>