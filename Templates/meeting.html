<html>
<head>
    <title>Meetings</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Basic loading animation */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #captions, #speech-captions {
            position: fixed;
            z-index: 100;
            display: flex;
            bottom: 7%;
            width: 100%;
            justify-content: center;
            color: #fff;
            padding: 10px;
        }

        #speech-captions {
            bottom: 2%; /* Display speech captions slightly above sign language captions */
        }
    </style>
</head>
<body>
    <!-- Loading animation -->
    <div id="loading">
        <div class="loader"></div>
    </div>

    <div style="display: flex; justify-content: center; align-items: top; height: 100vh;">
        <div id="root" style="width: 100%; height: 100%"></div>
    </div>

    <div id="captions" style="bottom:100px">
        <p id="transcript" style="background-color: black; padding: 5px; box-sizing: content-box; font-weight: bold; font-size: large; border-radius: 10%; border: solid 1px white; max-width: 700px;"></p>
    </div>
    
    <div id="speech-captions" style="bottom:60px">
        <p id="speech-transcription" style="background-color: black; padding: 5px; box-sizing: content-box; font-weight: bold; font-size: large; border-radius: 10%; border: solid 1px white; max-width: 700px;"></p>
    </div>

    <script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>
    <script>
        window.onload = function () {
            // Hide loading animation once the page has loaded
            document.getElementById('loading').style.display = 'none';

            // Web Speech API for speech-to-text
            if (!('webkitSpeechRecognition' in window)) {
                alert("Your browser does not support the Web Speech API. Please use Chrome or Edge.");
            } else {
                const recognition = new webkitSpeechRecognition();
                recognition.continuous = true; // Keep listening
                recognition.interimResults = true; // Show interim results
                recognition.lang = 'en-US'; // Set language to English

                // Get DOM elements for speech transcription
                const speechTranscription = document.getElementById('speech-transcription');

                // Start recognition when the video call starts
                let isMeetingStarted = false;

                function startSpeechRecognition() {
                    recognition.start();
                    speechTranscription.textContent = "Listening for speech...";
                }

                // Handle results from speech recognition
                recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    speechTranscription.textContent = transcript;
                };

                // Handle errors
                recognition.onerror = (event) => {
                    console.error("Error occurred:", event.error);
                    speechTranscription.textContent = "Error: " + event.error;
                };

                // Handle end of recognition
                recognition.onend = () => {
                    speechTranscription.textContent = "Recording stopped.";
                };

                function getUrlParams(url) {
                    let urlStr = url.split('?')[1];
                    const urlSearchParams = new URLSearchParams(urlStr);
                    return Object.fromEntries(urlSearchParams.entries());
                }

                const roomID = getUrlParams(window.location.href)['roomID'] || (Math.floor(Math.random() * 10000) + "");
                const userID = Math.floor(Math.random() * 10000) + "";
                const userName = "{{username}}";
                const appID = 922435240;
                const serverSecret = "10ba5f5065a32112f58e459aed99e5c0";
                const kitToken = ZegoUIKitPrebuilt.generateKitTokenForTest(appID, serverSecret, roomID, userID, userName);
                const zp = ZegoUIKitPrebuilt.create(kitToken);

                // Initialize meeting room
                zp.joinRoom({
                    container: document.querySelector("#root"),
                    sharedLinks: [{
                        name: 'Personal link',
                        url: window.location.protocol + '//' + window.location.host + window.location.pathname + '?roomID=' + roomID,
                    }],
                    scenario: { mode: ZegoUIKitPrebuilt.VideoConference },
                    turnOnMicrophoneWhenJoining: true,
                    turnOnCameraWhenJoining: true,
                    showMyCameraToggleButton: true,
                    showMyMicrophoneToggleButton: true,
                    showScreenSharingButton: true,
                    onMeetingStarted: () => {
                        isMeetingStarted = true;
                        startSpeechRecognition(); // Start speech recognition once the meeting starts
                    }
                });

                function speakTxt(textInput) {
                    let text = textInput.trim();
                    if (!text) return;

                    let speech = new SpeechSynthesisUtterance(text);
                    speech.lang = "en-US";
                    speech.rate = 1;
                    speech.pitch = 1;

                    window.speechSynthesis.speak(speech);
                }

                // Capture frames from the video element and send to backend
                setInterval(() => {
                    const videoElements = document.querySelectorAll('video');
                    if (videoElements.length === 0) return;

                    // Capture the first video element (modify to handle multiple participants)
                    const video = videoElements[0];
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                    // Convert canvas to base64
                    const imageData = canvas.toDataURL('image/jpeg');

                    // Send frame to backend for processing
                    fetch("/process_frame", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ frame: imageData }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.transcript) {
                            speakTxt(data.transcript);
                            var text = `Sign Captions -- "${data.transcript}" -- Sign Captions`;
                            document.getElementById("transcript").innerText = text;
                        } else {
                            document.getElementById("transcript").innerText = "";
                        }
                    })
                    .catch(error => console.error("Error:", error));
                }, 1000); // Set frame rate
            }
        };
    </script>
</body>
</html>
